pipeline {
    agent any
    environment {
        AWS_ACCESS_KEY_ID = credentials('ACESS_KEY')
        AWS_SECRET_ACCESS_KEY = credentials('SECRET_KEY')
        AWS_REGION = 'us-east-1'
    }
   
    stages {
        stage('Checkout SCM') {
            steps {
                script {
                    checkout(scmGit(
                        branches: [[name: '*/main']],
                        extensions: [],
                        userRemoteConfigs: [[url: 'https://github.com/Imsk31/angular-springboot.git']]
                    ))
                }
            }
        }
        stage('Logging into AWS ECR') {
            steps {
                script {
                sh """aws ecr-public get-login-password --region ${'AWS_REGION'} | docker login --username AWS --password-stdin public.ecr.aws/p0w5f0m4"""
                }
                 
            }
        }
  
    // Building Docker images
    stage('Building image') {
      steps{
        script {
          dir('angular-java/angular-frontend')
          sh'docker build -t backend .'
        }
      }
    }
   
    // Uploading Docker images into AWS ECR
    stage('Pushing to ECR') {
     steps{  
         script {
                sh """docker tag backend:latest public.ecr.aws/p0w5f0m4/backend:latest"""
                sh """docker push public.ecr.aws/p0w5f0m4/backend:latest"""
         }
        }
      }
    }
}